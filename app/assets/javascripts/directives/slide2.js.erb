(function () {

  angular.module('mainApp.directives').directive('slide2', ['Restangular', 'Notification', '$timeout', function(Restangular, Notification, $timeout) {
    return {
      restrict: 'E',
      templateUrl: 'home/slide2.html',
      scope: {
      },
      link: function(scope) {

        scope.newUni = "";
        scope.markerPerso = [];
        scope.showExistingSchool = false;
        scope.showNewSchool = false;
        scope.subdomainCreated = false;
        scope.geolocation = navigator.geolocation;

        Restangular.one('organizations').get().then(function (universities) {
          scope.universities = universities.plain();
        }, function(){
          console.log("Error: get univeristies marker");
        });

        var map;
        scope.marker = "";

        scope.$on('mapInitialized', function(evt, evtMap) {
          map = evtMap;
          addMarkers(scope.universities);
        });

        function addMarkers(list){
          if(list != undefined){
            list.forEach(function(node) {
              var pos = new google.maps.LatLng(node.latitude,node.longitude);
              var marker = new google.maps.Marker({
                position: pos,
                map: map,
                title: node.name,
                icon: '<%= asset_path "pin-institution.png" %>',
                place_id: node.place_id,
                subdomain: node.subdomain,
                name: node.name
              });
              google.maps.event.addListener(marker, 'click', function() {
                console.log("Ok: Marker clicked")

                if(scope.selectedMarkerPerso){
                  scope.selectedMarkerPerso.setAnimation(null);
                }
                scope.selectedMarkerPerso = marker;
                map.setCenter(marker.getPosition());
                zoomMap(9);

                scope.place = marker
                $('#existing-school-display-wrapper').addClass("school-ready-to-appear")
                scope.showExistingSchool = "http://" + marker.subdomain + ".unisphere.eu";



                scope.$apply()
              });

              scope.markerPerso.push(marker);
            });
          }
        }

        scope.centerMap = function(){
          if(navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
              var pos = new google.maps.LatLng(position.coords.latitude,position.coords.longitude);
              map.setCenter(pos);
              zoomMap(9);
            });
          } else {
            Notification.error("Your browser does not support geolocation")
          }
        }

        scope.clearPopup = function(){
          $('.school-popup-wrapper').removeClass("school-ready-to-appear")
          scope.showExistingSchool = undefined
          scope.showNewSchool = undefined
        }

        scope.placeChanged = function() {
          scope.place = this.getPlace();
          scope.showExistingSchool = findPlace(this.getPlace());

          $('.school-popup-wrapper').addClass("school-ready-to-appear")

          // We move the map to the place searched
          map.panTo(this.getPlace().geometry.location);

          // We zoom on the map
          zoomMap(9);

          // We remove the previous marker if there was one
          if(scope.selectedMarker){
            scope.selectedMarker.setMap(null);
          }

          // We remove the previous animation on the marker is there was one
          if(scope.selectedMarkerPerso){
            scope.selectedMarkerPerso.setAnimation(null);
          }

          // If the schools exist
          if(scope.showExistingSchool){
            console.log("school already uses unisphere");

            // We make the marker bounce
            scope.markerPerso.forEach(function(node){
              if(node.place_id == scope.place.place_id){
                scope.selectedMarkerPerso = node;
                // node.setAnimation(google.maps.Animation.BOUNCE);
              }
            })
          }
          // If the school doesn't exist
          else{
            // Gestion of popup
            scope.showNewSchool = true;

            // We add a marker on the map
            scope.selectedMarker = new google.maps.Marker({
              position: this.getPlace().geometry.location,
              map: map
            });
            console.log("school does not use unisphere")
          }

        }

        scope.currentPosition = function(){
          map.panTo("currentLocation")
        }

        /*=================================
        =            functions            =
        =================================*/

        function findPlace(place){
          var uni = false;
          scope.universities.forEach(function(node) {
            if(node.place_id == place.place_id){
              uni = "http://" + node.subdomain + ".unisphere.eu";
            }
          });
          return uni
        }

        function zoomMap(zoom){
          if(map.getZoom() < zoom){
            map.setZoom(map.getZoom() + 1);
            setTimeout(function(){
              zoomMap(zoom)
            },1000);
          }
        }

      }
    }

  }]);
}());
