(function () {
  'use strict';
  angular.module('mainApp.directives').directive('slide2', ['Restangular', '$auth', function(Restangular, $auth) {
    return {
      restrict: 'E',
      templateUrl: 'home/slide2.html',
      scope: {
        displayError: '=',
        displaySuccess: '='
      },
      link: function(scope) {

        scope.newUni = "";
        scope.markerPerso = [];
        scope.showExistingSchool = false;
        scope.showNewSchool = false;
        scope.subdomainCreated = false;
        scope.signupShow = false;
        scope.geolocation = navigator.geolocation;

        scope.adminEmail = "";

        Restangular.one('organizations').get().then(function (universities) {
          scope.universities = universities.plain();
        }, function(){
          console.log("There getting the universities");
        });

        var map;
        scope.marker = "";

        scope.$on('mapInitialized', function(evt, evtMap) {
          map = evtMap;
          putMarkers();
          // marker = map.markers[0];
        });

        function putMarkers(){
          scope.universities.forEach(function(node) {
            var pos = new google.maps.LatLng(node.latitude,node.longitude);
            var marker = new google.maps.Marker({
              position: pos,
              map: map,
              title: node.name,
              icon: '<%= asset_path "pin-colleg.png" %>',
              place_id: node.place_id
            });
            scope.markerPerso.push(marker);
          });
        }

        scope.centerMap = function(){
          if(navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
              var pos = new google.maps.LatLng(position.coords.latitude,position.coords.longitude);
              map.setCenter(pos);
              zoomMap(9);
            });
          } else {
            displayError("Your browser doesn't support geolocation");
          }
        }

        scope.placeChanged = function() {
          scope.place = this.getPlace();
          // console.log(scope.place);
          scope.showExistingSchool = findPlace(this.getPlace());
          scope.showNewSchoolUrl = false;
          scope.subdomainCreated = false;
          scope.signupShow = false;

          // We move the map to the place searched
          map.panTo(this.getPlace().geometry.location);

          // We zoom on the map
          zoomMap(9);

          // We remove the previous marker if there was one
          if(scope.selectedMarker){
            scope.selectedMarker.setMap(null);
          }

          // We remove the previous animation on the marker is there was one
          if(scope.selectedMarkerPerso){
            scope.selectedMarkerPerso.setAnimation(null);
          }

          // If the schools exist
          if(scope.showExistingSchool){
            console.log("school already uses unisphere");

            // Gestion of popup
            scope.showNewSchool = false;

            // We make the marker bounce
            scope.markerPerso.forEach(function(node){
              if(node.place_id == scope.place.place_id){
                scope.selectedMarkerPerso = node;
                node.setAnimation(google.maps.Animation.BOUNCE);
              }
            })
          } 
          // If the school doesn't exist 
          else{

            // Gestion of popup
            scope.showNewSchool = true;
            // console.log(scope.place);

            // We add a marker on the map
            scope.selectedMarker = new google.maps.Marker({
              position: this.getPlace().geometry.location,
              map: map
            });
            console.log("school doesnt use unisphere")
          }

        }

        scope.currentPosition = function(){
          map.panTo("currentLocation")
        }

        scope.displaySchool = function(){
          scope.showSchool = true;
        }

        scope.hideSchool = function(){
          scope.showSchool = false;
        }


        /*=============================================
        =            Creation of a new uni            =
        =============================================*/
        
        
        // Step 1 - Look up for uni / extract url
        scope.findUrl = function(){
          scope.showNewSchool = false;
          scope.signupShow =  true
        };

        //Step 2 - Creation. Send info to backend
        scope.signup = function(){
          if(scope.homeSignup.$invalid){
            if(scope.homeSignup.$error.email){
              console.log("ERROR: Enter a valid email");
              scope.displayError("You misstyped your email address")
            } else if(scope.homeSignup.$error.minlength){
              console.log("ERROR: your password is not long enough");
              scope.displayError("Your password needs to have at least 8 characters");
              scope.adminPassword = "";
            } else{
              console.log("ERROR: unknown");
              scope.displayError("Uknown error");
            }
          } else{
            var newUni = {
              name: scope.place.name,
              latitude: scope.place.geometry.location.A,
              longitude: scope.place.geometry.location.F,
              place_id: scope.place.place_id,
              website: scope.place.website
            }

            Restangular.all('organizations').post(newUni).then(function(d) {

              var newOrga = d;
              console.log("organization created");

              // We push the new uni to our local storage
              scope.universities.push(d.organization);

              // Sign up
              var credentials = {
                name: scope.adminName,
                email: scope.adminEmail,
                password: scope.adminPassword,
                password_confirmation: scope.adminPassword,
                organization_id: newOrga.organization.id
              };

              $auth.submitRegistration(credentials)
              .then(function(resp) { 
                console.log("User signup");
                
                // log in after sign in
                var login = {
                  email: scope.adminEmail,
                  password: scope.adminPassword
                };
                
                $auth.submitLogin(login)
                .then(function(d) {
                  console.log("User login")
                  scope.displaySuccess(scope.place.name + "is now using unisphere! We sent you a mail at " + scope.adminEmail)
                })
                .catch(function(d) {
                  console.log(d);
                  console.log("Unable to signin the user");
                  scope.displayError("Unknown error")
                });
                
              })
              .catch(function(d) { 
                console.log(d);
                if(d.status == 403){
                  console.log("Your email account is already bound to another organization");
                  scope.displayError("Currently we only allow a single organization per email addresses");
                } else{
                  scope.displayError("Impossible to create your account, try again.");
                }

                // We delete the organization we just created
                Restangular.all('organizations/' + newOrga.organization.id).remove().then(function() {
                  console.log("organization deleted");
                  console.log(d);
                }, function(d) {
                  console.log("impossible to delete the organization");
                  console.log(d);
                });

              });

              //We change popup
              scope.signupShow = false;
              scope.subdomainCreated =  true;

            }, function(d){
              console.log("merde alors");
              console.log(d);
              scope.displayError("Impossible to create a subdomain for " + scope.place.name + ", try again");
              scope.adminPassword = "";
            });

          }


        

        }

        scope.closePopupMap = function(){
          scope.showExistingSchool = false;
          scope.showNewSchool = false;
          scope.subdomainCreated = false;
          scope.signupShow = false;
        }
        
        /*=================================
        =            functions            =
        =================================*/
        
        function findPlace(place){
          var uni = false;
          scope.universities.forEach(function(node) {
            if(node.place_id == place.place_id){
              uni = node;
            }
          });
          return uni
        }

        function zoomMap(zoom){
          if(map.getZoom() < zoom){
            map.setZoom(map.getZoom() + 1);
            setTimeout(function(){
              zoomMap(zoom)
            },1000);
          }
        }


        // Restangular.one('organizations').get().then(function(response) {
        //   scope.universities = response;
        // }, function(d) {
        //   console.log("Error while getting the organizations");
        //   console.log(d);
        // });

        // scope.saveNewUni = function(){
        //   var uniToPush = {name: scope.newUniName}
        //   var uniToPost = {name: scope.newUniName, email: scope.newUniEmail, password: scope.newUniPassword}

        //   Restangular.all('organizations').post(uniToPost).then(function(d) {
        //     scope.universities.push(uniToPush);
        //     scope.newUniName = "";
        //     scope.newUniEmail = "";
        //     scope.newUniPassword = "";
        //   }, function(d){
        //     console.log("Error while creating the organization");
        //     console.log(d.data);
        //     scope.newUniPassword = "";
        //   });

        // };

      }
    }

  }]);
}());